<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CurrentAffairs Editor — HI+EN → DOCX (Fixed)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-Z..." crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  :root{--accent:#0b7a3e;--muted:#666;--card:#fff;--border:#e5e7eb}
  body{font-family:Arial,Helvetica,sans-serif;margin:14px;background:#f6f7fb;color:#111}
  .wrap{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1;min-width:320px;background:var(--card);border:1px solid var(--border);padding:12px;border-radius:8px;box-sizing:border-box}
  label{display:block;font-weight:600;margin-top:8px}
  input,textarea,select,button{font-size:14px}
  input,textarea,select{width:100%;padding:8px;margin:6px 0;border:1px solid #d0d7de;border-radius:6px;box-sizing:border-box}
  textarea{min-height:90px;resize:vertical}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:0;cursor:pointer}
  .btn-green{background:var(--accent);color:#fff}
  .btn-blue{background:#0d6efd;color:#fff}
  .btn-muted{background:#666;color:#fff}
  .card{border:1px solid #e8eaef;padding:10px;border-radius:8px;margin-bottom:10px;background:#fff}
  .card-header{display:flex;justify-content:space-between;align-items:center}
  .card-title{font-weight:700}
  .card-meta{font-size:12px;color:var(--muted)}
  .icon-btn{background:transparent;border:0;color:var(--muted);cursor:pointer;padding:6px;border-radius:6px}
  .icon-btn:hover{background:#f0f0f0;color:#000}
  .img-preview{max-width:220px;border-radius:6px;margin-top:8px;border:1px solid #ddd}
  .preview-body{white-space:pre-wrap;margin-top:8px}
  .small{font-size:13px;padding:6px 8px}
</style>
</head>
<body>
<h2>CurrentAffairs Editor — HI + EN → DOCX (Fixed)</h2>
<p style="color:var(--muted)">Add entries, edit inline, Translate (HI→EN), Export .docx (both languages). No raw preview, no separators inside docx.</p>

<div class="wrap">
  <div class="col" style="max-width:720px">
    <label>###currentAffair (fixed)</label>
    <input id="currentAffair" value="currentAffair" readonly>

    <div style="display:flex;gap:8px">
      <div style="flex:1">
        <label>###categories</label>
        <input id="categories" placeholder="politics, economy...">
      </div>
      <div style="width:160px">
        <label>###states</label>
        <input id="states" placeholder="INTERNATIONAL / Rajasthan">
      </div>
      <div style="width:110px">
        <label>###lang</label>
        <select id="lang"><option value="hi">hi</option><option value="en">en</option></select>
      </div>
    </div>

    <label>###title (Hindi)</label>
    <input id="title" placeholder="हिंदी में शीर्षक">

    <label>###banner (optional)</label>
    <input type="file" id="bannerInput" accept="image/*">
    <img id="bannerPreview" class="img-preview" style="display:none">

    <label>###body (Hindi)</label>
    <textarea id="body" placeholder="लेख यहाँ लिखो..."></textarea>

    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="addBtn" class="btn btn-green"><i class="fa fa-plus"></i> Add Entry</button>
      <button id="exportBtn" class="btn btn-blue"><i class="fa fa-file-word"></i> Export DOCX</button>
      <button id="exportJson" class="btn small btn-muted"><i class="fa fa-download"></i> Export JSON</button>
      <button id="importJson" class="btn small" style="background:#777;color:#fff"><i class="fa fa-upload"></i> Import JSON</button>
      <button id="translateAll" class="btn small" style="background:#ff8c00;color:#fff"><i class="fa fa-language"></i> Translate All</button>
      <button id="clearAll" class="btn small" style="background:#999;color:#fff"><i class="fa fa-trash"></i> Clear All</button>
    </div>

    <label style="margin-top:10px">Paste JSON here to import (array or single object)</label>
    <textarea id="jsonArea" style="height:90px;font-family:monospace"></textarea>
  </div>

  <div class="col" style="max-width:640px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Entries</strong></div>
      <div style="color:var(--muted)">Autosaved in browser</div>
    </div>
    <div id="entriesList" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* ====== State ====== */
const STORAGE = 'ca_fixed_v2';
let entries = []; // {id,categories,states,lang,titleHi,titleEn,bodyHi,bodyEn,banner:{name,type,dataURL},history:[],redo:[]}
let idc = 1;
const $ = id => document.getElementById(id);

/* load */
function load(){
  try{
    const s = localStorage.getItem(STORAGE);
    if(s){
      const obj = JSON.parse(s);
      entries = obj.entries || [];
      idc = obj.idc || (entries.length+1);
    }
  }catch(e){ console.warn(e); entries=[]; }
  render();
}
function save(){ try{ localStorage.setItem(STORAGE, JSON.stringify({entries,idc})); }catch(e){ console.warn(e); } }

/* helpers */
function uid(){ return 'id'+(idc++); }
function readFileToDataURL(input){ return new Promise(res=>{ const f = input.files && input.files[0]; if(!f) return res(null); const r = new FileReader(); r.onload = ()=> res({name:f.name,type:f.type,dataURL:r.result}); r.readAsDataURL(f); }); }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* banner preview temp */
let tmpBanner = null;
$('bannerInput').addEventListener('change', async ()=>{
  const d = await readFileToDataURL($('bannerInput'));
  if(d){ tmpBanner = d; $('bannerPreview').src = d.dataURL; $('bannerPreview').style.display='block'; }
});

/* add entry */
$('addBtn').addEventListener('click', ()=>{
  const ent = {
    id: uid(),
    categories: $('categories').value.trim(),
    states: $('states').value.trim(),
    lang: $('lang').value || 'hi',
    titleHi: $('title').value.trim(),
    titleEn: '',
    bodyHi: $('body').value.trim(),
    bodyEn: '',
    banner: tmpBanner ? {name:tmpBanner.name,type:tmpBanner.type,dataURL:tmpBanner.dataURL} : null,
    history: [], redo: []
  };
  // push initial snapshot
  ent.history.push(JSON.stringify({tHi:ent.titleHi,bHi:ent.bodyHi,tEn:ent.titleEn,bEn:ent.bodyEn,banner:ent.banner}));
  entries.unshift(ent);
  // clear input
  $('title').value=''; $('body').value=''; $('bannerInput').value=''; tmpBanner=null; $('bannerPreview').style.display='none';
  save(); render();
});

/* render list */
function render(){
  const list = $('entriesList'); list.innerHTML='';
  for(const e of entries){
    const card = document.createElement('div'); card.className='card'; card.dataset.id=e.id;
    const header = document.createElement('div'); header.className='card-header';
    const left = document.createElement('div');
    const titleDiv = document.createElement('div'); titleDiv.className='card-title'; titleDiv.textContent = e.titleHi || '(No title)';
    const meta = document.createElement('div'); meta.className='card-meta'; meta.textContent = (e.categories?e.categories+' | ':'') + (e.states||'');
    left.appendChild(titleDiv); left.appendChild(meta);

    const right = document.createElement('div');
    right.style.display='flex'; right.style.gap='6px';
    right.appendChild(icon('fa-pen','Edit', ()=> editInline(e.id)));
    right.appendChild(icon('fa-language','Translate', async ()=> { await translateEntry(e.id); }));
    right.appendChild(icon('fa-rotate-left','Undo', ()=> undoEntry(e.id)));
    right.appendChild(icon('fa-rotate-right','Redo', ()=> redoEntry(e.id)));
    right.appendChild(icon('fa-trash','Delete', ()=> { if(confirm('Delete entry?')) { entries = entries.filter(x=>x.id!==e.id); save(); render(); }}));
    header.appendChild(left); header.appendChild(right);
    card.appendChild(header);

    // content area
    const body = document.createElement('div'); body.style.marginTop='8px';
    if(e.banner && e.banner.dataURL){
      const im = document.createElement('img'); im.src=e.banner.dataURL; im.className='img-preview'; body.appendChild(im);
    }
    const titleHI = document.createElement('div'); titleHI.contentEditable = true; titleHI.style.fontWeight='700'; titleHI.style.marginTop='8px';
    titleHI.textContent = e.titleHi || '';
    titleHI.addEventListener('input', ()=> { e.titleHi = titleHI.textContent; pushHistory(e); save(); });
    body.appendChild(titleHI);

    const bodyHI = document.createElement('div'); bodyHI.contentEditable = true; bodyHI.className='preview-body'; bodyHI.style.minHeight='60px';
    bodyHI.textContent = e.bodyHi || '';
    bodyHI.addEventListener('input', ()=> { e.bodyHi = bodyHI.textContent; pushHistory(e); save(); });
    body.appendChild(bodyHI);

    // english editable
    const titleEN = document.createElement('div'); titleEN.contentEditable=true; titleEN.style.fontWeight='700'; titleEN.style.marginTop='10px'; titleEN.textContent = e.titleEn||'';
    titleEN.addEventListener('input', ()=> { e.titleEn = titleEN.textContent; pushHistory(e); save(); });
    body.appendChild(titleEN);
    const bodyEN = document.createElement('div'); bodyEN.contentEditable=true; bodyEN.className='preview-body'; bodyEN.textContent = e.bodyEn||''; bodyEN.addEventListener('input', ()=> { e.bodyEn = bodyEN.textContent; pushHistory(e); save(); });
    body.appendChild(bodyEN);

    card.appendChild(body);
    list.appendChild(card);
  }
}

/* icon helper */
function icon(cls,title,fn){
  const b = document.createElement('button'); b.className='icon-btn'; b.title=title; b.innerHTML = `<i class="fa ${cls}"></i>`;
  b.addEventListener('click',(ev)=>{ ev.stopPropagation(); fn(); });
  return b;
}

/* history */
function pushHistory(e){
  e.history = e.history || [];
  e.redo = e.redo || [];
  const snap = JSON.stringify({tHi:e.titleHi,bHi:e.bodyHi,tEn:e.titleEn,bEn:e.bodyEn,banner:e.banner});
  if(e.history[e.history.length-1] !== snap){ e.history.push(snap); if(e.history.length>60) e.history.shift(); e.redo=[]; }
}
function undoEntry(id){
  const e = entries.find(x=>x.id===id); if(!e || !e.history || e.history.length<=1) return alert('No undo available');
  const cur = e.history.pop(); e.redo.push(cur);
  const prev = e.history[e.history.length-1]; const obj = JSON.parse(prev);
  e.titleHi = obj.tHi; e.bodyHi = obj.bHi; e.titleEn = obj.tEn; e.bodyEn = obj.bEn; e.banner = obj.banner;
  save(); render();
}
function redoEntry(id){
  const e = entries.find(x=>x.id===id); if(!e || !e.redo || e.redo.length===0) return alert('No redo');
  const snap = e.redo.pop(); e.history.push(snap); const obj = JSON.parse(snap);
  e.titleHi = obj.tHi; e.bodyHi = obj.bHi; e.titleEn = obj.tEn; e.bodyEn = obj.bEn; e.banner = obj.banner;
  save(); render();
}

/* inline edit (focus first contenteditable) */
function editInline(id){
  const card = document.querySelector(`.card[data-id="${id}"]`);
  if(card){
    const ce = card.querySelector('[contenteditable="true"]');
    if(ce){ ce.focus(); placeCaretAtEnd(ce); }
  }
}
function placeCaretAtEnd(el){ el.focus(); if(window.getSelection && document.createRange){ const r=document.createRange(); r.selectNodeContents(el); r.collapse(false); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); } }

/* translate entry */
async function translateEntry(id){
  const e = entries.find(x=>x.id===id); if(!e) return;
  if(e.titleHi) e.titleEn = await translateApi(e.titleHi);
  if(e.bodyHi) e.bodyEn = await translateApi(e.bodyHi);
  pushHistory(e); save(); render();
}

/* translate all */
$('translateAll').addEventListener('click', async ()=>{
  for(const e of entries){
    if(e.titleHi) e.titleEn = await translateApi(e.titleHi);
    if(e.bodyHi) e.bodyEn = await translateApi(e.bodyHi);
    pushHistory(e);
  }
  save(); render(); alert('Translated all (HI→EN)');
});

async function translateApi(text){
  if(!text) return '';
  try{
    const q = encodeURIComponent(text);
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=hi&tl=en&dt=t&q=${q}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Translate failed ' + res.status);
    const data = await res.json();
    const segs = data[0].map(s=>s[0]).filter(Boolean);
    return segs.join('');
  }catch(e){ console.warn(e); return ''; }
}

/* import JSON */
$('importJson').addEventListener('click', ()=> {
  const v = $('jsonArea').value.trim(); if(!v) return alert('Paste JSON');
  try{
    const parsed = JSON.parse(v);
    const arr = Array.isArray(parsed)? parsed : [parsed];
    arr.forEach(o=>{
      const ent = {
        id: uid(),
        categories: o.categories||'',
        states: o.states||'',
        lang: o.lang||'hi',
        titleHi: o.title||o.titleHi||'',
        titleEn: o.titleEn||'',
        bodyHi: o.body||o.bodyHi||'',
        bodyEn: o.bodyEn||'',
        banner: o.banner||null,
        history: [], redo: []
      };
      ent.history.push(JSON.stringify({tHi:ent.titleHi,bHi:ent.bodyHi,tEn:ent.titleEn,bEn:ent.bodyEn,banner:ent.banner}));
      entries.unshift(ent);
    });
    save(); render(); alert('Imported ' + arr.length + ' entries');
  }catch(e){ alert('Invalid JSON'); console.error(e); }
});

/* export json */
$('exportJson').addEventListener('click', ()=> {
  const out = entries.map(e=>({
    categories:e.categories, states:e.states, lang:e.lang,
    titleHi:e.titleHi, titleEn:e.titleEn, bodyHi:e.bodyHi, bodyEn:e.bodyEn, banner:e.banner
  }));
  const blob = new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='current_affairs.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),3000);
});

/* clear all */
$('clearAll').addEventListener('click', ()=> { if(!confirm('Clear all entries?')) return; entries=[]; save(); render(); });

/* autosave interval */
setInterval(save,2000);

/* ====== DOCX builder (fixed) ====== */

/* drawing xml */
function makeDrawingXml(rId, cx=4500000, cy=3000000){
  return `<w:p><w:r><w:drawing><wp:inline xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"><wp:extent cx="${cx}" cy="${cy}"/><wp:docPr id="1" name="Image"/><a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"><a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture"><pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture"><pic:nvPicPr><pic:cNvPr id="0" name="Image"/><pic:cNvPicPr/></pic:nvPicPr><pic:blipFill><a:blip xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" r:embed="${rId}"/><a:stretch><a:fillRect/></a:stretch></pic:blipFill><pic:spPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="${cx}" cy="${cy}"/></a:xfrm><a:prstGeom prst="rect"><a:avLst/></a:prstGeom></pic:spPr></pic:pic></a:graphicData></a:graphic></wp:inline></w:drawing></w:r></w:p>`;
}

function xmlEscape(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* build document xml with both languages for all entries (no separators) */
function buildDocumentXml(relMapPerEntry){
  let body = '';
  for(let i=0;i<entries.length;i++){
    const e = entries[i];
    const rmap = relMapPerEntry[i] || {};
    // HI
    body += `<w:p><w:r><w:t>###currentAffair</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape($('currentAffair').value)}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###categories</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.categories||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###states</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.states||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###lang</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>hi</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###title</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.titleHi||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###banner</w:t></w:r></w:p>`;
    if(rmap.banner) body += makeDrawingXml(rmap.banner, 4500000, 3000000);
    else body += `<w:p><w:r><w:t></w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###body</w:t></w:r></w:p>`;
    (e.bodyHi||'').split(/\n+/).forEach(p => { body += `<w:p><w:r><w:t>${xmlEscape(p)}</w:t></w:r></w:p>`; });

    // EN
    body += `<w:p><w:r><w:t>###currentAffair</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape($('currentAffair').value)}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###categories</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.categories||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###states</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.states||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###lang</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>en</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###title</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.titleEn||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###banner</w:t></w:r></w:p>`;
    if(rmap.banner) body += makeDrawingXml(rmap.banner, 4500000, 3000000);
    else body += `<w:p><w:r><w:t></w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###body</w:t></w:r></w:p>`;
    (e.bodyEn||'').split(/\n+/).forEach(p => { body += `<w:p><w:r><w:t>${xmlEscape(p)}</w:t></w:r></w:p>`; });
  }
  const doc = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
            xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
            xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
            xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
            xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
  <w:body>
    ${body}
    <w:p/><w:sectPr/>
  </w:body>
</w:document>`;
  return doc;
}

/* Build package files */
function buildPackageFiles(){
  const media = [];
  entries.forEach((e, idx) => {
    if(e.banner && e.banner.dataURL){
      const d = e.banner;
      const comma = d.dataURL.indexOf(',');
      const b64 = d.dataURL.slice(comma+1);
      const binStr = atob(b64);
      const u8 = new Uint8Array(binStr.length);
      for(let i=0;i<binStr.length;i++) u8[i] = binStr.charCodeAt(i);
      let ext='png';
      if(d.type && d.type.indexOf('jpeg')!==-1) ext='jpg';
      const name = `image${media.length+1}.${ext}`;
      media.push({name,type:d.type||('image/'+ext),data:u8,entryIndex:idx});
    }
  });

  // map rel ids
  const relMapPerEntry = entries.map(()=>({banner:null}));
  media.forEach((m,i)=>{ relMapPerEntry[m.entryIndex].banner = 'rIdImg'+(i+1); });

  const documentXml = buildDocumentXml(relMapPerEntry);

  // rels xml
  let relsXml = `<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">`;
  media.forEach((m,i)=> relsXml += `\n  <Relationship Id="rIdImg${i+1}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/${m.name}"/>`);
  relsXml += `\n</Relationships>`;

  // content types
  const extMap = {};
  media.forEach(m=> { const ext = m.name.split('.').pop(); extMap[ext]=m.type; });
  let ct = `<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml" ContentType="application/xml"/>\n`;
  Object.keys(extMap).forEach(ext => { ct += `  <Default Extension="${ext}" ContentType="${extMap[ext]}"/>\n`; });
  ct += `  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>\n</Types>`;

  const files = {};
  files["[Content_Types].xml"] = ct;
  files["_rels/.rels"] = `<?xml version="1.0"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>\n</Relationships>`;
  files["word/_rels/document.xml.rels"] = relsXml;
  files["word/document.xml"] = documentXml;
  media.forEach(m => files[`word/media/${m.name}`] = m.data);
  return files;
}

/* ZIP builder (binary-safe stable) */
function buildZip(files){
  const encoder = new TextEncoder();
  function toBytes(v){ if(v instanceof Uint8Array) return v; if(typeof v==='string') return encoder.encode(v); return encoder.encode(String(v)); }
  function u32(n){ return [n & 0xff, (n>>8)&0xff, (n>>16)&0xff, (n>>24)&0xff]; }

  // crc table
  let table = window.__crcTable;
  if(!table){
    table = new Uint32Array(256);
    for(let n=0;n<256;n++){ let c=n; for(let k=0;k<8;k++) c = (c&1) ? (0xEDB88320 ^ (c>>>1)) : (c>>>1); table[n]=c>>>0; }
    window.__crcTable = table;
  }
  function crc32(buf){
    let crc = 0 ^ -1;
    for(let i=0;i<buf.length;i++) crc = (crc>>>8) ^ table[(crc ^ buf[i]) & 0xff];
    return (crc ^ -1) >>> 0;
  }

  const local = [], central = [];
  let offset = 0;
  for(const name in files){
    const data = toBytes(files[name]);
    const fname = encoder.encode(name);
    const crc = crc32(data);
    const compSize = data.length;
    const uncompSize = data.length;

    const lh = new Uint8Array(30 + fname.length);
    lh.set([0x50,0x4b,0x03,0x04],0);
    lh.set([20,0],4); lh.set([0,0],6); lh.set([0,0],8);
    // time/date 4 bytes left zero
    lh.set(u32(crc),14);
    lh.set(u32(compSize),18);
    lh.set(u32(uncompSize),22);
    lh[26] = fname.length & 0xff; lh[27] = (fname.length >> 8) & 0xff;
    lh.set(fname,30);
    local.push(lh); local.push(data);

    const ch = new Uint8Array(46 + fname.length);
    ch.set([0x50,0x4b,0x01,0x02],0);
    ch.set([20,0],4); ch.set([20,0],6);
    ch.set(u32(crc),16);
    ch.set(u32(compSize),20);
    ch.set(u32(uncompSize),24);
    ch[28] = fname.length & 0xff; ch[29] = (fname.length>>8)&0xff;
    ch.set(u32(offset),42);
    ch.set(fname,46);
    central.push(ch);

    offset += lh.length + data.length;
  }

  const centralSize = central.reduce((s,c)=> s+c.length, 0);
  const eocd = new Uint8Array(22);
  eocd.set([0x50,0x4b,0x05,0x06],0);
  const entries = central.length;
  eocd[8] = entries & 0xff; eocd[9] = (entries>>8)&0xff;
  eocd[10] = entries & 0xff; eocd[11] = (entries>>8)&0xff;
  const cdStart = offset;
  eocd.set(u32(centralSize),12);
  eocd.set(u32(cdStart),16);

  const out = new Uint8Array(offset + centralSize + 22);
  let p=0;
  for(const part of local){ out.set(part,p); p += part.length; }
  for(const c of central){ out.set(c,p); p+=c.length; }
  out.set(eocd,p);
  return new Blob([out], {type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
}

/* export click */
$('exportBtn').addEventListener('click', ()=> {
  save(); // ensure saved
  if(entries.length===0){ if(!confirm('No entries - export empty doc?')) return; }
  try{
    const files = buildPackageFiles();
    const blob = buildZip(files);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'current_affairs.docx'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url),5000);
  }catch(e){ console.error(e); alert('Export failed: '+ (e && e.message)); }
});

/* init */
load();
render();

</script>
</body>
</html>
